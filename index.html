<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动物园规则怪谈 - 胆小者勿入</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Special+Elite&display=swap');
        
        :root {
            --primary-color: #8b0000;
            --secondary-color: #4fc3f7;
            --bg-color: #0a0a0a;
            --paper-color: #1a1a1a;
            --border-color: #333;
            --text-color: #e0e0e0;
            --accent-color: #ff4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Special Elite', cursive;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* 恐怖背景效果 */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(28, 58, 112, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(28, 58, 112, 0.1) 0%, transparent 20%),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23333' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.7;
            z-index: -1;
        }
        
        /* 闪烁的红色灯光效果 */
        @keyframes redFlash {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.3; }
        }
        
        .red-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(139, 0, 0, 0.3) 0%, transparent 70%);
            animation: redFlash 4s infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        /* 恐怖边框效果 */
        .blood-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, transparent 95%, var(--accent-color) 100%),
                linear-gradient(180deg, transparent 95%, var(--accent-color) 100%),
                linear-gradient(270deg, transparent 95%, var(--accent-color) 100%),
                linear-gradient(0deg, transparent 95%, var(--accent-color) 100%);
            background-size: 10px 10px;
            pointer-events: none;
            z-index: 5;
            opacity: 0.7;
        }
        
        /* 新布局样式 */
        .game-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            padding: 20px;
        }
        
        /* 右上角小地图 */
        .mini-map {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background-color: rgba(26, 26, 26, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            z-index: 10;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .mini-map-title {
            font-size: 0.9em;
            color: var(--accent-color);
            margin-bottom: 5px;
            text-align: center;
        }
        
        .mini-map-content {
            width: 100%;
            height: calc(100% - 20px);
            background-color: rgba(40, 40, 40, 0.8);
            border-radius: 3px;
            display: flex;
            flex-wrap: wrap;
            padding: 5px;
        }
        
        .map-area-mini {
            width: 30%;
            height: 40%;
            margin: 1.5%;
            background-color: rgba(60, 60, 60, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .map-area-mini:hover {
            border-color: var(--accent-color);
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }
        
        .map-area-mini.current {
            background-color: rgba(139, 0, 0, 0.3);
            border-color: var(--accent-color);
        }
        
        /* 侧边栏 */
        .sidebar {
            width: 300px;
            background-color: rgba(26, 26, 26, 0.9);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            position: relative;
            z-index: 2;
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(100%);
        }
        
        /* 侧边栏箭头 */
        .sidebar-toggle {
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 40px;
            background-color: rgba(26, 26, 26, 0.9);
            border: 1px solid var(--border-color);
            border-right: none;
            border-radius: 5px 0 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--accent-color);
            font-size: 1.2em;
            transition: all 0.3s;
        }
        
        .sidebar-toggle:hover {
            background-color: rgba(40, 40, 40, 0.9);
        }
        
        /* 右下角设置按钮 */
        .settings-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(26, 26, 26, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--accent-color);
            font-size: 1.2em;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .settings-button:hover {
            background-color: rgba(40, 40, 40, 0.9);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        
        /* 设置模态框 */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .settings-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .settings-content {
            width: 80%;
            max-width: 600px;
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        
        .settings-title {
            font-size: 1.5em;
            color: var(--accent-color);
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Creepster', cursive;
        }
        
        /* 内容区样式 */
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.7);
            position: relative;
            margin-top: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        
        .location-title {
            font-size: 2em;
            color: var(--accent-color);
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            font-family: 'Creepster', cursive;
        }
        
        .location-description {
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 1.1em;
        }
        
        .interaction-area {
            background-color: rgba(40, 40, 40, 0.8);
            padding: 15px;
            border: 1px dashed var(--border-color);
            border-radius: 5px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .event-title {
            font-size: 1.2em;
            color: var(--accent-color);
            margin-bottom: 10px;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }
        
        .choices {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            font-family: 'Special Elite', cursive;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        
        button:hover {
            background-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        button:hover::before {
            left: 100%;
        }
        
        /* 规则样式 */
        .rules-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.3em;
            color: var(--accent-color);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }
        
        .rule {
            margin-bottom: 10px;
            padding: 8px 12px;
            background-color: rgba(40, 40, 40, 0.7);
            border-left: 3px solid var(--primary-color);
            position: relative;
            transition: all 0.3s;
        }
        
        .rule:hover {
            background-color: rgba(60, 60, 60, 0.7);
            transform: translateX(5px);
        }
        
        .rule-number {
            font-weight: bold;
            color: var(--accent-color);
            margin-right: 5px;
        }
        
        .warning {
            background-color: rgba(80, 0, 0, 0.5);
            border-left: 3px solid var(--accent-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        
        .view-all-rules {
            background-color: var(--secondary-color);
            color: #333;
            margin-top: 10px;
            width: 100%;
        }
        
        .view-all-rules:hover {
            background-color: #29b6f6;
        }
        
        /* 规则模态框 */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .rules-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .rules-content {
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            overflow-y: auto;
        }
        
        .rules-title {
            font-size: 1.5em;
            color: var(--accent-color);
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Creepster', cursive;
        }
        
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--accent-color);
        }
        
        /* 状态栏 */
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: rgba(26, 26, 26, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .status-label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .progress-bar {
            width: 100px;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            transition: width 0.3s;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .inventory-item {
            padding: 5px 10px;
            background-color: rgba(50, 50, 50, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .inventory-item:hover {
            border-color: var(--accent-color);
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="red-flash"></div>
    <div class="blood-border"></div>
    
    <div class="game-container">
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 右上角小地图 -->
            <div class="mini-map">
                <div class="mini-map-title">动物园地图</div>
                <div class="mini-map-content">
                    <div class="map-area-mini" data-area="entrance">入口</div>
                    <div class="map-area-mini" data-area="rabbit">兔子区</div>
                    <div class="map-area-mini" data-area="lion">狮子区</div>
                    <div class="map-area-mini" data-area="elephant">大象区</div>
                    <div class="map-area-mini" data-area="ape">猿类区</div>
                    <div class="map-area-mini" data-area="market">超市</div>
                </div>
            </div>
            
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-label">认知稳定性:</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cognitionBar" style="width: 100%;"></div>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-label">已探索区域:</span>
                    <span id="exploredAreas">0/6</span>
                </div>
                <div class="status-item">
                    <span class="status-label">当前位置:</span>
                    <span id="currentLocation">动物园入口</span>
                </div>
            </div>
            
            <!-- 内容区 -->
            <div class="content-area">
                <h1 class="location-title" id="areaTitle">动物园入口</h1>
                <div class="location-description" id="areaDescription">
                    您刚刚进入动物园，手中拿着入园时发放的地图和游客守则。请选择您想参观的区域开始您的旅程。
                    记住，遵守规则是确保您安全的关键。
                </div>
                
                <div class="interaction-area" id="interactionArea">
                    <!-- 交互内容将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 右下角设置按钮 -->
            <div class="settings-button" onclick="toggleSettings()">⚙</div>
        </div>
        
        <!-- 右侧边栏 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-toggle" onclick="toggleSidebar()">◀</div>
            
            <div class="rules-section">
                <div class="section-title">当前区域规则</div>
                <div class="triggered-rules-list" id="currentRules">
                    <div class="rule">暂无特定规则</div>
                </div>
                <button class="view-all-rules" onclick="toggleRules()">查看全部规则</button>
            </div>
            
            <div class="rules-section">
                <div class="section-title">物品栏</div>
                <div class="inventory" id="inventory">
                    <div class="inventory-item">动物园地图</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 设置模态框 -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <button class="close-button" onclick="toggleSettings()">×</button>
            <h2 class="settings-title">游戏设置</h2>
            
            <div class="rules-section">
                <div class="section-title">存档管理</div>
                <div class="save-slots" id="saveSlots">
                    <!-- 存档槽位将通过JavaScript动态生成 -->
                </div>
                <button class="btn" onclick="saveGame()" style="width: 100%; margin-top: 10px;">保存游戏</button>
            </div>
            
            <div class="rules-section">
                <div class="section-title">游戏控制</div>
                <button class="btn" onclick="returnToStart()" style="width: 100%; margin-top: 10px;">返回主菜单</button>
                <button class="btn" onclick="startNewGame()" style="width: 100%; margin-top: 10px;">重新开始</button>
            </div>
        </div>
    </div>
    
    <!-- 规则模态框 -->
    <div class="rules-modal" id="rulesModal">
        <div class="rules-content">
            <button class="close-button" onclick="toggleRules()">×</button>
            <h2 class="rules-title">动物园游客守则</h2>
            
            <div class="rule">
                <span class="rule-number">1.</span> 本园安全措施保障绝对没有问题，动物没有出逃的可能性，尤其是小型草食动物大多被关押在不可触摸的封闭性环境里。
            </div>
            
            <div class="rule">
                <span class="rule-number">2.</span> 猿类的园区只有一条街道，且只展示猿类动物。如果您发现了两条街道，且展示动物包括兔子，请选择左边那条，并尽可能快速地结束对该园区的参观。
            </div>
            
            <div class="rule">
                <span class="rule-number">3.</span> 大象是一种体型巨大、有着扇子一般的耳朵、鼻子很长、腿粗得像柱子的生物，而且不是白色的。请确保你在大象园区看见的是且只有大象。
            </div>
            
            <div class="rule">
                <span class="rule-number">4.</span> 动物园的超市不提供"兔子血"，如果您在货架上看见了，请不要购买。
            </div>
            
            <div class="rule">
                <span class="rule-number">5.</span> 不要独自停留在兔子园区的树荫下。
            </div>
            
            <div class="rule">
                <span class="rule-number">6.</span> 本园没有海洋馆。如果有工作人员向您贩卖海洋馆的票，拒绝他们。
            </div>
            
            <div class="rule">
                <span class="rule-number">7.</span> 如果您已经看见了海洋馆，立刻离开，并打通地图上标记的电话进行告知。
            </div>
            
            <div class="rule">
                <span class="rule-number">8.</span> 不要投喂兔子。其余的动物都可以。
            </div>
            
            <div class="rule">
                <span class="rule-number">9.</span> 兔子不会发出笑声。如果您在参观兔子园区时听见明显不来自游客方向的笑声，离开园区前，请把地图上虚线处撕下来握住，在彻底离开动物园时不要离手。
            </div>
            
            <div class="rule">
                <span class="rule-number">10.</span> 如果您触犯了以上任何一条，并且发现自己正在迷路状态，和其他熟人走散，请立刻在一刻钟内找到离您最近的超市，告知那里穿蓝色工作服的售货员（注意，如果看见穿黑色工作服的售货员，不论对方对您说什么都请假装没听见），他会马上带您到狮子园区的工作通道。不要害怕，这里的狮子不会袭击您，躲在假山后面，等所有的白狮子都开始吼叫后，工作人员将会带你离开园区（请确认他是蓝色衣服），这时候你的家人朋友会在狮子园区门口等着你。在这一切之后，立刻离开动物园。
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        let gameState = {
            currentArea: 'entrance',
            visitedAreas: ['entrance'],
            triggeredRules: [],
            cognitiveStability: 100,
            inventory: ['map'],
            hasMap: true,
            hasDashedLine: false,
            endings: [],
            currentEvent: null,
            gameStarted: false,
            sidebarCollapsed: false
        };

        // 区域信息
        const areas = {
            entrance: {
                title: '动物园入口',
                description: '您刚刚进入动物园，手中拿着入园时发放的地图和游客守则。请选择您想参观的区域开始您的旅程。记住，遵守规则是确保您安全的关键。',
                rules: []
            },
            rabbit: {
                title: '兔子园区',
                description: '这里展示着各种可爱的兔子。园区内有许多灌木和树荫，兔子们在围栏内安静地活动。',
                rules: [
                    "不要独自停留在兔子园区的树荫下。",
                    "兔子不会发出笑声。如果您在参观兔子园区时听见明显不来自游客方向的笑声，离开园区前，请把地图上虚线处撕下来握住，在彻底离开动物园时不要离手。"
                ]
            },
            lion: {
                title: '狮子园区',
                description: '雄伟的白狮子在园区内悠闲地踱步。园区中央有一个假山，是狮子们休息的地方。',
                rules: [
                    "本园只有四头白狮子。如果在第十条描述的情况中你看见了四头以上白狮子在吼叫，不要离开园区，并告知工作人员，等白狮子数量恢复四头后再离开。",
                    "狮子园区是安全的。如果您遭遇任何您无法解决的危险事件，也无法求助，请立刻、不择手段、尽一切可能前往狮子园区。"
                ]
            },
            elephant: {
                title: '大象园区',
                description: '庞大的大象在园区内活动。园区边缘有标示牌，描述了大象的特征和习性。',
                rules: [
                    "大象是一种体型巨大、有着扇子一般的耳朵、鼻子很长、腿粗得像柱子的生物，而且不是白色的。请确保你在大象园区看见的是且只有大象。",
                    "如果看见有戴兔子耳饰的人跟随人流进入大象园区，必须放弃参观该园区。如果违反本条，本园不对您的安全负责，且无法给您提供解决方案。"
                ]
            },
            ape: {
                title: '猿类园区',
                description: '聪明的猿类在园区内活动。这里只有一条街道，展示着各种猿类动物。',
                rules: [
                    "猿类的园区只有一条街道，且只展示猿类动物。如果您发现了两条街道，且展示动物包括兔子，请选择左边那条，并尽可能快速地结束对该园区的参观。"
                ]
            },
            market: {
                title: '超市',
                description: '园区内的超市提供各种饮料和零食。货架上摆满了商品，店员穿着蓝色工作服。',
                rules: [
                    "动物园的超市不提供\"兔子血\"，如果您在货架上看见了，请不要购买。",
                    "如果您触犯了以上任何一条，并且发现自己正在迷路状态，和其他熟人走散，请立刻在一刻钟内找到离您最近的超市，告知那里穿蓝色工作服的售货员。"
                ]
            },
            aquarium: {
                title: '海洋馆',
                description: '一个不应该存在的建筑。里面展示着各种海洋生物，但似乎有些异常。',
                rules: [
                    "本园没有海洋馆。如果有工作人员向您贩卖海洋馆的票，拒绝他们。",
                    "如果您已经看见了海洋馆，立刻离开，并打通地图上标记的电话进行告知。",
                    "海洋馆内部告示：不要在有人时进入海洋馆。如果你进来后有工作人员接待了你，在看完这条告示后请立刻找借口离开。"
                ]
            }
        };

        // 初始化游戏
        function startNewGame() {
            gameState = {
                currentArea: 'entrance',
                visitedAreas: ['entrance'],
                triggeredRules: [],
                cognitiveStability: 100,
                inventory: ['map'],
                hasMap: true,
                hasDashedLine: false,
                endings: [],
                currentEvent: null,
                gameStarted: true,
                sidebarCollapsed: false
            };
            
            updateGameDisplay();
            updateSaveSlots();
        }

        // 切换侧边栏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.sidebar-toggle');
            
            gameState.sidebarCollapsed = !gameState.sidebarCollapsed;
            sidebar.classList.toggle('collapsed');
            toggle.textContent = gameState.sidebarCollapsed ? '▶' : '◀';
        }

        // 切换设置模态框
        function toggleSettings() {
            const settingsModal = document.getElementById('settingsModal');
            settingsModal.classList.toggle('active');
        }

        // 切换规则模态框
        function toggleRules() {
            const rulesModal = document.getElementById('rulesModal');
            rulesModal.classList.toggle('active');
        }

        // 访问区域
        function visitArea(areaId) {
            if (!gameState.visitedAreas.includes(areaId)) {
                gameState.visitedAreas.push(areaId);
            }
            
            gameState.currentArea = areaId;
            updateGameDisplay();
            
            // 随机触发事件
            if (Math.random() > 0.5) {
                triggerRandomEvent(areaId);
            }
        }

        // 触发随机事件
        function triggerRandomEvent(areaId) {
            const eventTemplates = {
                rabbit: [
                    {
                        title: '逃跑的兔子',
                        description: '您发现一只兔子从围栏中逃了出来，正在路边吃草。',
                        choices: [
                            { text: '远离并报告工作人员', outcome: '您按照规则远离了兔子并找到了工作人员。工作人员迅速处理了情况。', rules: [1], stability: 0 },
                            { text: '靠近观察', outcome: '您靠近了兔子，它突然停止吃草，用红色的眼睛盯着您。您感到一阵不安。', rules: [1], stability: -10 },
                            { text: '尝试触摸', outcome: '当您伸手想要触摸兔子时，它突然高速向您冲来！您慌忙后退，心跳加速。', rules: [1], stability: -20 }
                        ]
                    }
                ],
                lion: [
                    {
                        title: '白狮子数量异常',
                        description: '您注意到白狮子的数量似乎超过了四头。',
                        choices: [
                            { text: '立即报告工作人员', outcome: '您立即向蓝衣员工报告了情况。员工点点头，迅速前往处理。', rules: [11], stability: 0 },
                            { text: '继续观察', outcome: '您继续观察白狮子，发现它们的眼睛似乎有些异常。您感到不安。', rules: [11], stability: -10 },
                            { text: '装作没看见', outcome: '您装作没看见异常，但感觉有视线在背后盯着您。', rules: [11], stability: -15 }
                        ]
                    }
                ]
                // 其他区域的事件类似...
            };
            
            const events = eventTemplates[areaId] || [];
            if (events.length > 0) {
                const eventIndex = Math.floor(Math.random() * events.length);
                const event = events[eventIndex];
                gameState.currentEvent = event;
                
                const interactionArea = document.getElementById('interactionArea');
                interactionArea.innerHTML = `
                    <div class="event-title">${event.title}</div>
                    <div class="area-description">${event.description}</div>
                    <div class="choices">
                        ${event.choices.map((choice, index) => 
                            `<button class="choice-btn" onclick="makeChoice(${index})">${choice.text}</button>`
                        ).join('')}
                    </div>
                    <div id="eventOutcome" class="outcome"></div>
                `;
            }
        }

        // 做出选择
        function makeChoice(choiceIndex) {
            const event = gameState.currentEvent;
            const choice = event.choices[choiceIndex];
            
            // 更新游戏状态
            gameState.cognitiveStability += choice.stability;
            if (gameState.cognitiveStability > 100) gameState.cognitiveStability = 100;
            if (gameState.cognitiveStability < 0) gameState.cognitiveStability = 0;
            
            // 添加触发的规则
            choice.rules.forEach(rule => {
                if (!gameState.triggeredRules.includes(rule)) {
                    gameState.triggeredRules.push(rule);
                }
            });
            
            // 显示结果
            const outcomeElement = document.getElementById('eventOutcome');
            outcomeElement.innerHTML = `<p>${choice.outcome}</p>`;
            outcomeElement.style.display = 'block';
            
            // 更新显示
            updateGameDisplay();
        }

        // 更新游戏显示
        function updateGameDisplay() {
            const area = areas[gameState.currentArea];
            
            // 更新当前位置
            document.getElementById('currentLocation').textContent = area.title;
            
            // 更新区域信息
            document.getElementById('areaTitle').textContent = area.title;
            document.getElementById('areaDescription').textContent = area.description;
            
            // 更新认知稳定性
            document.getElementById('cognitionBar').style.width = `${gameState.cognitiveStability}%`;
            
            // 更新已探索区域
            document.getElementById('exploredAreas').textContent = `${gameState.visitedAreas.length - 1}/6`;
            
            // 更新当前区域规则
            const currentRulesElement = document.getElementById('currentRules');
            if (area.rules.length === 0) {
                currentRulesElement.innerHTML = '<div class="rule">暂无特定规则</div>';
            } else {
                currentRulesElement.innerHTML = area.rules.map(rule => 
                    `<div class="rule">${rule}</div>`
                ).join('');
            }
            
            // 更新物品栏
            const inventoryElement = document.getElementById('inventory');
            inventoryElement.innerHTML = gameState.inventory.map(item => 
                `<div class="inventory-item">${getItemName(item)}</div>`
            ).join('');
            
            // 更新小地图
            updateMiniMap();
        }

        // 更新小地图
        function updateMiniMap() {
            const miniMapAreas = document.querySelectorAll('.map-area-mini');
            miniMapAreas.forEach(area => {
                const areaId = area.getAttribute('data-area');
                area.classList.remove('current');
                
                if (areaId === gameState.currentArea) {
                    area.classList.add('current');
                }
                
                if (gameState.visitedAreas.includes(areaId)) {
                    area.style.opacity = '1';
                } else {
                    area.style.opacity = '0.5';
                }
                
                // 添加点击事件
                area.onclick = () => visitArea(areaId);
            });
        }

        // 获取物品名称
        function getItemName(item) {
            const itemNames = {
                'map': '动物园地图',
                'dashedLine': '地图虚线部分'
            };
            
            return itemNames[item] || item;
        }

        // 保存游戏
        function saveGame() {
            const saveData = {
                ...gameState,
                saveTime: new Date().toLocaleString()
            };
            
            let saves = JSON.parse(localStorage.getItem('zooRuleSaves') || '[]');
            
            if (saves.length >= 3) {
                saves.shift();
            }
            
            saves.push(saveData);
            localStorage.setItem('zooRuleSaves', JSON.stringify(saves));
            
            updateSaveSlots();
            alert('游戏已保存！');
        }

        // 加载游戏
        function loadGame(saveIndex) {
            const saves = JSON.parse(localStorage.getItem('zooRuleSaves') || '[]');
            if (saves.length > saveIndex) {
                gameState = saves[saveIndex];
                gameState.gameStarted = true;
                updateGameDisplay();
                toggleSettings();
            }
        }

        // 更新存档槽位显示
        function updateSaveSlots() {
            const saveSlotsElement = document.getElementById('saveSlots');
            const saves = JSON.parse(localStorage.getItem('zooRuleSaves') || '[]');
            
            if (saves.length === 0) {
                saveSlotsElement.innerHTML = '<div class="rule">暂无存档</div>';
            } else {
                saveSlotsElement.innerHTML = saves.map((save, index) => `
                    <div class="rule" onclick="loadGame(${index})" style="cursor: pointer;">
                        <span class="rule-number">${index + 1}.</span> ${save.saveTime}
                    </div>
                `).join('');
            }
        }

        // 返回开始界面
        function returnToStart() {
            // 在实际实现中，这里应该返回开始界面
            alert('返回主菜单功能');
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            startNewGame();
            updateSaveSlots();
            
            // 为小地图区域添加点击事件
            const miniMapAreas = document.querySelectorAll('.map-area-mini');
            miniMapAreas.forEach(area => {
                const areaId = area.getAttribute('data-area');
                area.onclick = () => visitArea(areaId);
            });
        });
    </script>
</body>
</html>
